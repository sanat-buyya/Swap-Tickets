<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Sell Ticket</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" href="/docs/swaplogo.png" type="image/png">
    <style>
        :root {
            --primary-color: #4a6bff;
            --secondary-color: #f8f9fa;
            --accent-color: #ff6b6b;
            --text-color: #333;
            --light-gray: #e9ecef;
            --border-color: #dee2e6;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            background-image: url('https://www.transparenttextures.com/patterns/cubes.png');
        }

        h1, h2, h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        h1 {
            text-align: center;
            margin: 20px 0;
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .steps-link {
            color: #4285f4;
            text-decoration: none;
            font-weight: bold;
        }

        .steps-link:hover {
            text-decoration: underline;
        }

        .form-container {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .form-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--light-gray);
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .form-group {
            margin-bottom: 18px;
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 15px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 15px;
            transition: border 0.3s ease;
        }

        input:focus, select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 107, 255, 0.1);
        }

        /* Gender Radio Button Styles */
        .gender-radio-group {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }

        .gender-radio-option {
            flex: 1;
        }

        .gender-radio-input {
            position: absolute;
            opacity: 0;
        }

        .gender-radio-tile {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            height: 100%;
        }

        .gender-radio-input:checked + .gender-radio-tile {
            border-color: var(--primary-color);
            background-color: #f0f4ff;
        }

        .gender-radio-icon {
            font-size: 24px;
            margin-bottom: 5px;
            color: #555;
        }

        .gender-radio-input:checked + .gender-radio-tile .gender-radio-icon {
            color: var(--primary-color);
        }

        .gender-radio-label {
            font-size: 14px;
            font-weight: 500;
            color: #555;
        }

        .gender-radio-input:checked + .gender-radio-tile .gender-radio-label {
            color: var(--primary-color);
        }

        /* Autocomplete Dropdown Styles */
        .autocomplete-container {
            position: relative;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .autocomplete-suggestion {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }

        .autocomplete-suggestion:hover,
        .autocomplete-suggestion.highlighted {
            background-color: var(--secondary-color);
        }

        .autocomplete-suggestion:last-child {
            border-bottom: none;
        }

        .station-code {
            font-weight: 600;
            color: var(--primary-color);
        }

        .station-name {
            font-size: 14px;
            color: #666;
            margin-left: 8px;
        }
        
        .autocomplete-container {
            position: relative;
        }

        .suggestions {
            position: absolute;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
            margin-top: 5px;
        }

        .suggestions-header {
            padding: 8px 12px;
            font-size: 12px;
            color: #666;
            border-bottom: 1px solid #eee;
        }

        .suggestion-item {
            padding: 10px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .suggestion-item:hover, .suggestion-item.highlighted {
            background-color: #f5f5f5;
        }

        .station-name {
            font-weight: 500;
        }

        .station-code {
            color: #2a78f5;
            font-size: 0.9em;
            background:  #f0f4ff;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }

        .no-suggestions {
            padding: 10px;
            text-align: center;
            color: #666;
        }

        .no-suggestions i {
            margin-bottom: 5px;
            color: #aaa;
        }

        .no-suggestions small {
            display: block;
            margin-top: 5px;
            font-size: 0.8em;
        }

        .passenger-block {
            background: var(--secondary-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary-color);
            position: relative;
        }

        .remove-passenger {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--accent-color);
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 15px;
            position: relative;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #3a5bef;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
            min-width: 180px;
            position: relative;
        }

        .btn-success:hover:not(:disabled) {
            background-color: #218838;
            transform: translateY(-2px);
        }

        .btn-success:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .btn-add {
            background-color: var(--info-color);
            color: white;
            margin-bottom: 20px;
        }

        .btn-add:hover {
            background-color: #138496;
        }

        .terms-checkbox {
            display: flex;
            align-items: center;
            margin: 20px 0;
            font-size: 14px;
        }

        .terms-checkbox input {
            width: auto;
            margin-right: 10px;
        }

        .note {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type="file"] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
        }

        .file-input-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border: 1px dashed var(--border-color);
            padding: 30px;
            border-radius: 6px;
            text-align: center;
            background: var(--secondary-color);
            color: #666;
            font-weight: 500;
        }

        .file-input-btn:hover {
            background: #e9ecef;
        }

        .file-name {
            margin-top: 5px;
            font-size: 13px;
            color: var(--primary-color);
            display: none;
        }

        /* Loader Animation Styles */
        .loader {
            width: 60px;
            height: 22px;
            -webkit-mask: radial-gradient(circle closest-side,#000 94%,#0000) left/20% 100%;
            background: linear-gradient(#000 0 0) left/0% 100% no-repeat #ddd;
            animation: l17 2s infinite steps(6);
            display: none;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
        
        @keyframes l17 {
            100% {background-size:120% 100%}
        }

        .btn-text {
            transition: opacity 0.3s ease;
        }

        .btn-loading .btn-text {
            opacity: 0;
        }

        .btn-loading .loader {
            display: block;
        }

        /* Number of Tickets Styling */
        .ticket-count-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ticket-count-input {
            max-width: 80px;
            text-align: center;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            .form-container {
                padding: 20px;
            }
            h1 {
                font-size: 1.7rem;
            }
            input, select, textarea {
                padding: 10px 12px;
            }
            .passenger-block {
                padding: 15px;
            }
            
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            .form-container {
                padding: 15px;
            }
            h1 {
                font-size: 1.5rem;
            }
            .btn {
                padding: 10px 15px;
                font-size: 14px;
            }
            .ticket-count-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            .ticket-count-input {
                max-width: 100%;
            }
        }

        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .passenger-block {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>

<body>
    <h1><i class="fas fa-ticket-alt"></i> Sell Your Ticket</h1>
    
    <div class="form-container">
        <form th:action="@{/pnr/sell}" method="post" enctype="multipart/form-data" id="sellTicketForm">
            <!-- PNR + Train Info -->
            <div class="form-section">
                <h3><i class="fas fa-train"></i> Journey Details</h3>
                
            <div class="form-group">
    			<label for="pnrNumber">PNR Number</label>
                  <input type="text" id="pnrNumber" name="pnrNumber" pattern="\d{10}" title="PNR must be exactly 10 digits" required maxlength="10" inputmode="numeric" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,10)">
			</div>

            <div class="form-group">
    			<label for="trainNumber">Train Number</label>
    			<input type="text" id="trainNumber" name="trainNumber" pattern="\d{5}" title="Train Number must be exactly 5 digits" required maxlength="5" inputmode="numeric" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,5)">
			</div>

                <div class="form-group">
                    <label for="fromStation">From Station</label>
                    <div class="autocomplete-container">
                        <input type="text" id="fromStation" name="fromStation" placeholder="Enter station name or code" required autocomplete="off">
                        <div class="suggestions" id="suggestions-fromStation"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="toStation">To Station</label>
                    <div class="autocomplete-container">
                        <input type="text" id="toStation" name="toStation" placeholder="Enter station name or code" required autocomplete="off">
                        <div class="suggestions" id="suggestions-toStation"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="journeyDate">Journey Date</label>
                    <input type="date" id="journeyDate" name="journeyDate" th:min="${T(java.time.LocalDate).now()}" required>
                </div>

                <div class="form-group">
                    <label for="numberOfTickets">Number of Passengers</label>
                    <div class="ticket-count-container">
                        <input type="number" id="numberOfTickets" name="numberOfTickets" min="1" max="6" value="1" class="ticket-count-input" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Ticket Image</label>
                    <div class="file-input-wrapper">
                        <div class="file-input-btn">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>Click to upload ticket image</span>
                        </div>
                        <input type="file" name="ticketImage" accept=".jpg,.jpeg,.png,.pdf" required onchange="showFileName(this)">
                    </div>
                    <div class="file-name" id="ticketFileName"></div>
                </div>
            </div>

            <!-- Seller Info -->
            <div class="form-section">
                <h3><i class="fas fa-user-circle"></i> Seller Information</h3>
                
                <div class="form-group">
                    <label for="sellerMobile">Mobile Number</label>
                    <input type="tel" id="sellerMobile" name="sellerMobile" placeholder="Enter Mobile Number" pattern="[0-9]{10}" required maxlength="10" inputmode="numeric" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,10)">
                </div>

                <div class="form-group">
    <label for="upiId">UPI ID</label>
    <input type="text" id="upiId" name="upiId" placeholder="Enter Your UPI Id" required>
    
    <!-- This is where the holder name will appear -->
   <!-- <div id="upiHolderName" style="margin-top: 5px; font-weight: bold; color: green;"></div>      -->
    
    <div class="note">For receiving payment after journey completion</div>
</div>
      

                <div class="terms-checkbox">
                    <input type="checkbox" id="acceptUpi" name="acceptUpi" required>
                    <label for="acceptUpi"> Confirm Your UPI Number</label>
                </div>
            </div>

            <!-- Passenger Details -->
            <div class="form-section">
                <h3><i class="fas fa-users"></i> Passenger Details</h3>
                <p class="note">Add details for each passenger on the ticket</p>
                <div id="passenger-container"></div>
                <button type="button" class="btn btn-add" onclick="addPassenger()">
                    <i class="fas fa-plus"></i> Add Passenger
                </button>
            </div>

            <!-- Terms and Submit -->
            <div class="terms-checkbox">
                <input type="checkbox" id="acceptTerms" name="acceptTerms" required>
                <label for="acceptTerms">I accept the <a href="/terms">Terms and Conditions</a></label>
            </div>

            <p class="note">
                <i class="fas fa-info-circle"></i> Check your ticket status in My Tickets. Payment will be transferred after journey completion.
            </p>

            <div style="text-align: center; margin-top: 30px;">
                <button type="submit" class="btn btn-success" id="submitBtn">
                    <div class="loader"></div>
                    <span class="btn-text">
                        <i class="fas fa-paper-plane"></i> Submit Ticket
                    </span>
                </button>
            </div>
        </form>
    </div>

    <div style="text-align: center; margin-top: 20px;">
        <a th:href="@{/user/home}">
            <button class="btn btn-secondary"> Back to Home</button>
        </a>
    </div>

   <script>
    let passengerCount = 0;
    let indianRailwayStations = [];
    let currentHighlightedIndex = -1;
	
    document.getElementById("upiId").addEventListener("blur", function() { 
        const upiId = this.value.trim();
        const holderDiv = document.getElementById("upiHolderName");

        if (upiId.length > 5) { // Basic validation
            holderDiv.textContent = "Verifying...";
            holderDiv.style.color = "orange";

            // IMPORTANT: backend expects 'vpa', not 'upiId'
            fetch(`/pnr/verify?vpa=${encodeURIComponent(upiId)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Verification failed");
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        holderDiv.textContent = `Account Holder: ${data.name}`;
                        holderDiv.style.color = "green";
                    } else {
                        holderDiv.textContent = data.message || "Invalid UPI ID";
                        holderDiv.style.color = "red";
                    }
                })
                .catch(error => {
                    holderDiv.textContent = "Error verifying UPI";
                    holderDiv.style.color = "red";
                });
        } else {
            holderDiv.textContent = "";
        }
    });
    // Fetch stations from backend API
    fetch('/api/stations')
        .then(response => response.json())
        .then(data => {
            indianRailwayStations = data;
            setupStationAutocomplete(['fromStation', 'toStation']);
        })
        .catch(error => {
            console.error('Error loading stations:', error);
            // Fallback to local station data if API fails
            indianRailwayStations = [
                // Your existing station data here...
                { name: "Bangalore City Junction", code: "SBC", state: "Karnataka", district: "Bangalore Urban", zone: "SWR" },
                // ... rest of your station data
            ];
            setupStationAutocomplete(['fromStation', 'toStation']);
        });

    function setupStationAutocomplete(inputIds) {
        inputIds.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (!input) return;

            let lastValidValue = "";

            input.addEventListener('input', function() {
                debounceSearch(this);
            });

            input.addEventListener('keydown', function(event) {
                handleKeyNavigation(this, event);
            });

            input.addEventListener('focus', function() {
                if (this.value.length >= 2) {
                    showStationSuggestions(this);
                }
            });

            input.addEventListener('blur', function() {
                setTimeout(() => {
                    const suggestions = document.getElementById(`suggestions-${this.id}`);
                    if (suggestions) suggestions.remove();
                    currentHighlightedIndex = -1;

                    // Validate input: only allow if matches a suggestion
                    const value = input.value.trim();
                    const valid = indianRailwayStations.some(station =>
                        value === `${station.name} (${station.code})`
                    );
                    if (!valid) {
                        input.value = "";
                    }
                }, 200);
            });

            // When a suggestion is clicked, set the input value
            input.addEventListener('stationSelected', function(e) {
                lastValidValue = e.detail.value;
                input.value = lastValidValue;
            });
        });

        document.addEventListener('click', function(event) {
            if (!event.target.closest('.autocomplete-container')) {
                document.querySelectorAll('.suggestions').forEach(s => s.remove());
                currentHighlightedIndex = -1;
            }
        });
    }

    // Update suggestion click handler in showStationSuggestions:
    function showStationSuggestions(input) {
        const query = input.value.toLowerCase().trim();
        const suggestionsId = `suggestions-${input.id}`;
        const existingSuggestions = document.getElementById(suggestionsId);
        if (existingSuggestions) existingSuggestions.remove();
        if (query.length < 2) return;

        const filteredStations = indianRailwayStations.filter(station =>
            station.name.toLowerCase().includes(query) ||
            station.code.toLowerCase().includes(query)
        ).slice(0, 8);

        const suggestionsDiv = document.createElement('div');
        suggestionsDiv.className = 'suggestions';
        suggestionsDiv.id = suggestionsId;

        if (filteredStations.length === 0) {
            const noResults = document.createElement('div');
            noResults.className = 'no-suggestions';
            noResults.innerHTML = `
                <i class="fas fa-search"></i>
                <div>No stations found matching "${input.value}"</div>
                <small>Try searching by station name or code</small>
            `;
            suggestionsDiv.appendChild(noResults);
        } else {
            const headerDiv = document.createElement('div');
            headerDiv.className = 'suggestions-header';
            headerDiv.textContent = `${filteredStations.length} station(s) found`;
            suggestionsDiv.appendChild(headerDiv);

            filteredStations.forEach((station, index) => {
                const suggestionDiv = document.createElement('div');
                suggestionDiv.className = 'suggestion-item';
                suggestionDiv.innerHTML = `
                    <div class="station-info">
                        <div class="station-name">${station.name}</div>
                    </div>
                    <div class="station-code">${station.code}</div>
                `;
                suggestionDiv.addEventListener('click', () => {
                    const selectedValue = `${station.name} (${station.code})`;
                    input.value = selectedValue;
                    suggestionsDiv.remove();
                    currentHighlightedIndex = -1;
                    // Fire custom event for validation
                    input.dispatchEvent(new CustomEvent('stationSelected', { detail: { value: selectedValue } }));
                });
                suggestionsDiv.appendChild(suggestionDiv);
            });
        }

        input.parentElement.appendChild(suggestionsDiv);
        currentHighlightedIndex = -1;
    }

    function handleKeyNavigation(input, event) {
        const suggestions = document.getElementById(`suggestions-${input.id}`);
        if (!suggestions) return;

        const items = suggestions.querySelectorAll('.suggestion-item');
        if (items.length === 0) return;

        switch (event.key) {
            case 'ArrowDown':
                event.preventDefault();
                currentHighlightedIndex = Math.min(currentHighlightedIndex + 1, items.length - 1);
                updateHighlight(items);
                break;
            case 'ArrowUp':
                event.preventDefault();
                currentHighlightedIndex = Math.max(currentHighlightedIndex - 1, -1);
                updateHighlight(items);
                break;
            case 'Enter':
                event.preventDefault();
                if (currentHighlightedIndex >= 0 && items[currentHighlightedIndex]) {
                    items[currentHighlightedIndex].click();
                }
                break;
            case 'Escape':
                suggestions.remove();
                currentHighlightedIndex = -1;
                break;
        }
    }

    function updateHighlight(items) {
        items.forEach((item, index) => {
            item.classList.toggle('highlighted', index === currentHighlightedIndex);
        });
    }

    // Debounce function for better performance
    let searchTimeout;
    function debounceSearch(input) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            showStationSuggestions(input);
        }, 300);
    }

    // Form submission with loader
    document.getElementById('sellTicketForm')?.addEventListener('submit', function(e) {
        const submitBtn = this.querySelector('button[type="submit"]');
        if (submitBtn) {
            const btnText = submitBtn.querySelector('.btn-text');
            const loader = submitBtn.querySelector('.loader');

            // Add loading state
            submitBtn.classList.add('btn-loading');
            submitBtn.disabled = true;
            btnText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
        }
    });

    function addPassenger() {
        const container = document.getElementById('passenger-container');
        const ticketCountInput = document.getElementById('numberOfTickets');
        const maxTickets = parseInt(ticketCountInput?.max || 6);

        // Check if we've reached maximum tickets
        if (passengerCount >= maxTickets) {
            alert(`Maximum ${maxTickets} tickets allowed per PNR`);
            return;
        }

        const index = passengerCount++;

        // Increment the ticket count
        if (ticketCountInput) {
            ticketCountInput.value = passengerCount;
        }

        const block = document.createElement('div');
        block.className = 'passenger-block';
        block.innerHTML = `
            <button type="button" class="remove-passenger" onclick="removePassenger(this)">
                <i class="fas fa-times"></i>
            </button>
            <div class="form-group">
                <label>Passenger Name</label>
                <input type="text" name="passengerNames[${index}]" required>
            </div>
            <div class="form-group">
                <label>Gender</label>
                <div class="gender-radio-group">
                    <label class="gender-radio-option">
                        <input type="radio" name="genders[${index}]" value="Male" class="gender-radio-input" required>
                        <span class="gender-radio-tile">
                            <span class="gender-radio-icon"><i class="fa-solid fa-person"></i></span>
                            <span class="gender-radio-label">Male</span>
                        </span>
                    </label>
                    <label class="gender-radio-option">
                        <input type="radio" name="genders[${index}]" value="Female" class="gender-radio-input">
                        <span class="gender-radio-tile">
                            <span class="gender-radio-icon"><i class="fa-solid fa-person-dress"></i></span>
                            <span class="gender-radio-label">Female</span>
                        </span>
                    </label>
                    <label class="gender-radio-option">
                        <input type="radio" name="genders[${index}]" value="Other" class="gender-radio-input">
                        <span class="gender-radio-tile">
                            <span class="gender-radio-icon"><i class="fa-solid fa-people-arrows"></i></span>
                            <span class="gender-radio-label">Other</span>
                        </span>
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label>Age</label>
                <input type="number" name="ages[${index}]" min="1" max="120" required>
            </div>
            <div class="form-group">
                <label>Coach Class</label>
                <select name="coaches[${index}]" class="coach-select" data-index="${index}" required onchange="updateSeatOptions(this)">
                    <option value="">-- Select Class --</option>
                    <option value="SL">Sleeper (SL)</option>
                    <option value="3A">AC 3 Tier (3A)</option>
                    <option value="2A">AC 2 Tier (2A)</option>
                    <option value="1A">AC First Class (1A)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Seat Number</label>
                <select name="seats[${index}]" class="seat-number" id="seat-${index}" required>
                    <option value="">-- Seat Format --</option>
                </select>
            </div>
            <div class="form-group">
                <label>Price (₹)</label>
                <input type="number" step="0.01" name="prices[${index}]" placeholder="Enter IRCTC ticket price for each passenger" required>
                <div class="note">Enter the price for each passenger ticket (SINGLE PASSENGER).</div>
            </div>
            <div class="form-group">
                <label>ID Proof Document</label>
                <div class="file-input-wrapper">
                    <div class="file-input-btn">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span>Upload ID Proof</span>
                    </div>
                    <input type="file" name="documentUrls" accept=".jpg,.jpeg,.png" required onchange="showPassengerFileName(this, ${index})">
                </div>
                <div class="note">Can be upload a masked document only in jpg, jpeg (e.g., Aadhaar with last 4 digits visible) for each Passenger
                    <a href="/maskedAadhar">Steps</a>
                </div>
                <div class="file-name" id="passengerFile${index}"></div>
            </div>
        `;
        container.appendChild(block);
    }
	
    function checkUpiName() {
        const vpa = document.getElementById("upiId").value.trim();
        if (vpa.length > 5) {
          fetch('/pnr/verify-upi', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: 'vpa=' + encodeURIComponent(vpa)
          })
          .then(res => res.text())
          .then(name => {
            document.getElementById("upiHolderName").innerText = name;
          })
          .catch(() => {
            document.getElementById("upiHolderName").innerText = "Error verifying UPI";
          });
        }
      }
    
    function removePassenger(button) {
        const container = document.getElementById('passenger-container');
        const block = button.parentNode;
        container.removeChild(block);
        passengerCount--;

        // Update the ticket count
        const ticketCountInput = document.getElementById('numberOfTickets');
        if (ticketCountInput) {
            ticketCountInput.value = passengerCount;
        }

        // Reindex remaining passengers
        const passengerBlocks = container.getElementsByClassName('passenger-block');
        for (let i = 0; i < passengerBlocks.length; i++) {
            const inputs = passengerBlocks[i].querySelectorAll('input, select');
            inputs.forEach(input => {
                const name = input.name.replace(/\[\d+\]/, `[${i}]`);
                input.name = name;
            });

            const fileInput = passengerBlocks[i].querySelector('input[type="file"]');
            if (fileInput) {
                fileInput.setAttribute('onchange', `showPassengerFileName(this, ${i})`);
            }
        }
    }

    function showFileName(input) {
        const fileNameDisplay = document.getElementById('ticketFileName');
        if (input.files.length > 0 && fileNameDisplay) {
            fileNameDisplay.textContent = input.files[0].name;
            fileNameDisplay.style.display = 'block';
        }
    }

    function showPassengerFileName(input, index) {
        const fileNameDisplay = document.getElementById(`passengerFile${index}`);
        if (input.files.length > 0 && fileNameDisplay) {
            fileNameDisplay.textContent = input.files[0].name;
            fileNameDisplay.style.display = 'block';
        }
    }

    function updateSeatOptions(selectElement) {
        const index = selectElement.dataset.index;
        const seatSelect = document.getElementById('seat-' + index);
        const selectedCoach = selectElement.value;

        if (!seatSelect) return;

        seatSelect.innerHTML = '<option value="">-- Seat Format --</option>';

        if (selectedCoach === 'SL') {
            generateBerthOptions(seatSelect, 'S', 1, 12, 80);
        } else if (selectedCoach === '3A') {
            generateBerthOptions(seatSelect, 'B', 1, 9, 72);
        } else if (selectedCoach === '2A') {
            generateBerthOptions(seatSelect, 'A', 1, 3, 54);
        } else if (selectedCoach === '1A') {
            generateBerthOptions(seatSelect, 'H', 1, 2, 30);
        }
    }

    function generateBerthOptions(selectElement, prefix, coachStart, coachEnd, maxBerthsPerCoach) {
        for (let i = coachStart; i <= coachEnd; i++) {
            for (let b = 1; b <= maxBerthsPerCoach; b++) {
                const code = `${prefix}${i}/${b}`;
                const option = document.createElement('option');
                option.value = code;
                option.textContent = code;
                selectElement.appendChild(option);
            }
        }
    }

    // Add first passenger by default
    window.onload = function() {
        addPassenger();

        // Link number of tickets to passenger count
        const ticketCountInput = document.getElementById('numberOfTickets');
        if (ticketCountInput) {
            ticketCountInput.addEventListener('change', function() {
                const ticketCount = parseInt(this.value);
                const passengerContainer = document.getElementById('passenger-container');
                const currentPassengers = passengerContainer.children.length;

                if (ticketCount > currentPassengers) {
                    // Add missing passengers
                    for (let i = currentPassengers; i < ticketCount; i++) {
                        addPassenger();
                    }
                } else if (ticketCount < currentPassengers) {
                    // Remove extra passengers
                    while (passengerContainer.children.length > ticketCount) {
                        passengerContainer.removeChild(passengerContainer.lastChild);
                        passengerCount--;
                    }
                }
            });
        }
    };
</script>
</body>
</html>